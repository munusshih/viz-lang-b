<!doctype html>
<html lang="en">

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/p5.party@latest/dist/p5.party.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/@davepagurek/p5.filterrenderer@0.0.18/p5.filterRenderer.min.js"></script>
  <meta charset="utf-8" />
</head>

<body>
  <main></main>
  <script>
    if (window.p5 && window.p5.prototype) {
      window.p5.prototype._loadingScreen = function () {
        this.clear();
        this.background(246, 243, 238);
        this.fill(26, 26, 26);
        this.noStroke();
        this.textAlign(this.CENTER, this.CENTER);
        this.textFont("Comfortaa");
        this.textSize(14);
        this.text("Loading...", this.width / 2, this.height / 2);
      };
    }
  </script>
  <script>
    let me;
    let guests;
    let img;
    let gap = Math.abs(Math.random() * 50) + 250;

    function preload() {
      partyConnect("wss://demoserver.p5party.org", "chairs_happy");
      img = loadImage('/assets/texture.webp');

      // Default chair parameters + placeholder position
      me = partyLoadMyShared({
        seatW: random(30, 50) * 2,
        seatD: random(40, 80) * 2,
        seatH: 6 * 2,
        backH: random(35, 55) * 2,
        legH: random(30, 60) * 2,
        legW: 5 * 2,
        x: 0,
        y: 0,
        z: 0,
      });

      guests = partyLoadGuestShareds();
    }

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);
      // partyToggleInfo(true);

      let camRadius = windowWidth; // <-- reduce this to move camera closer
      let camY = -60; // height of the camera
      let camAngle = -100; // slowly rotate around scene
      let camX = camRadius * cos(camAngle);
      let camZ = camRadius * sin(camAngle);
      camera(camX, camY, camZ, 0, 0, 0, 0, 1, 0); // look at center

      noStroke();
      strokeWeight(1);
    }

    function draw() {
      clear();
      ambientLight(0);
      translate(0, 50, 0);

      let camRadius = 300000 / windowWidth + guests.length * 100; // <-- reduce this to move camera closer
      let camY = -60; // height of the camera
      let camAngle = -100 + frameCount * 0.002; // slowly rotate around scene
      let camX = camRadius * cos(camAngle);
      let camZ = camRadius * sin(camAngle);
      camera(camX, camY, camZ, 0, 0, 0, 0, 1, 0); // look at center
      orbitControl();

      let total = 1 + guests.length;
      let radius = (gap * total) / TWO_PI;

      // build a list of everyone (me first)
      let people = [me, ...guests];

      // compute max leg height so chairs sit on same floor
      let maxLegH = Math.max(...people.map((p) => p.legH));

      for (let i = 0; i < people.length; i++) {
        let p = people[i];

        let angle = (i / total) * TWO_PI;
        let newX = radius * cos(angle);
        let newZ = radius * sin(angle);
        let newY = maxLegH - p.legH;

        // Only update shared object if it's ready (for me) or if it's a guest
        if (i === 0 && partyIsHost()) {
          // Only update if the shared object is ready
          if (me && me._isReady) {
            p.x = newX;
            p.z = newZ;
            p.y = newY;
          }
        } else if (i > 0) {
          // Guests can be updated
          p.x = newX;
          p.z = newZ;
          p.y = newY;
        }

        push();
        translate(newX, newY, newZ);
        rotateY(atan2(-newX, -newZ) + PI);
        drawChair(p);
        pop();
      }
    }

    function drawChair(chair) {
      ambientMaterial('DodgerBlue');
      // texture(img)

      let { seatW, seatD, seatH, backH, legH, legW } = chair;

      push();
      translate(0, -seatH / 2, 0);
      box(seatW, seatH, seatD);
      pop();

      push();
      translate(0, -seatH / 2 - backH / 2, seatD / 2 - 3);
      box(seatW, backH, 6);
      pop();

      let lx = seatW / 2 - 5;
      let lz = seatD / 2 - 5;

      push();
      translate(-lx, legH / 2, -lz);
      box(legW, legH, legW);
      pop();
      push();
      translate(lx, legH / 2, -lz);
      box(legW, legH, legW);
      pop();
      push();
      translate(-lx, legH / 2, lz);
      box(legW, legH, legW);
      pop();
      push();
      translate(lx, legH / 2, lz);
      box(legW, legH, legW);
      pop();
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>

  <style>
    body {
      overflow: hidden;
      margin: 0 !important;
      font-family: "Comfortaa", sans-serif;
    }

    html {
      overflow: hidden;
    }
  </style>
</body>

</html>