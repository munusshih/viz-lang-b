---
import Layout from "@/layouts/Layout.astro";
import Footer from "@/components/Footer.astro";
import Nav from "@/components/Nav.astro";
import CourseInfo from "@/components/CourseInfo.astro";
import { SITE_DESCRIPTION, SITE_TITLE, SECTION_ID } from "@/config";
import { getCollection } from "astro:content";
import { marked } from "marked";

// Get all weeks and sort by week number
const allWeeks = await getCollection("weeks");
const sortedWeeks = allWeeks
  .filter((week) => week.data.page !== false)
  .sort((a, b) => a.data.week - b.data.week);

// Get the latest week (highest week number)
const latestWeek = sortedWeeks[sortedWeeks.length - 1];
---

<Layout
  title={`This Week - ${SITE_TITLE}: ${SECTION_ID}`}
  description={SITE_DESCRIPTION}
>
  <header>
    <div class="course-info flex flex-col">
      <CourseInfo />
      <h1>This Week</h1>
    </div>
  </header>
  <main>
    <Nav />
    {
      latestWeek && (
        <section class="this-week">
          <div class="week-header">
            <div class="week-number">Week {latestWeek.data.week}</div>
            <h2 class="week-title">{latestWeek.data.title}</h2>
          </div>

          {latestWeek.data.longDescription && (
            <div
              class="week-content"
              set:html={marked.parse(latestWeek.data.longDescription)}
            />
          )}

          <div class="week-link-container">
            <a href={`/${latestWeek.id}/`} class="view-full-link">
              View Full Week Details â†’
            </a>
          </div>
        </section>
      )
    }
  </main>
  <Footer />
</Layout>

<style>
  .this-week {
    margin: 0 auto;
    max-width: 900px;
  }

  .week-header {
    margin-bottom: 2rem;
    border-bottom: 2px solid #000;
    padding-bottom: 1rem;
  }

  .week-number {
    opacity: 0.5;
    margin-bottom: 0.5rem;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .week-title {
    margin: 0;
    font-weight: 700;
    font-size: 2.5rem;
    line-height: 1.2;
  }

  .week-content {
    font-size: 1.05rem;
    line-height: 1.8;
  }

  .week-content :global(h2) {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 700;
    font-size: 1.75rem;
  }

  .week-content :global(h3) {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
    font-size: 1.25rem;
  }

  .week-content :global(img) {
    margin: 1.5rem 0;
    border-radius: 4px;
    max-width: 100%;
    height: auto;
  }

  .week-content :global(a) {
    color: #0066cc;
    text-decoration: underline;
  }

  .week-content :global(a:hover) {
    opacity: 0.7;
  }

  .week-content :global(ul) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .week-content :global(li) {
    margin: 0.5rem 0;
  }

  .week-link-container {
    margin-top: 3rem;
    border-top: 1px solid #ddd;
    padding-top: 2rem;
  }

  .view-full-link {
    display: inline-block;
    transition: opacity 0.2s ease;
    border-radius: 4px;
    background: #000;
    padding: 0.75rem 1.5rem;
    color: #fff;
    font-weight: 600;
    text-decoration: none;
  }

  .view-full-link:hover {
    opacity: 0.8;
  }

  @media (max-width: 768px) {
    .week-title {
      font-size: 2rem;
    }

    .week-content {
      font-size: 1rem;
    }
  }
</style>
