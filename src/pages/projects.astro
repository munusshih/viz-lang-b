---
import Layout from "@/layouts/Layout.astro";
import Footer from "@/components/Footer.astro";
import Nav from "@/components/Nav.astro";
import CourseInfo from "@/components/CourseInfo.astro";
import { SITE_DESCRIPTION, SITE_TITLE, SECTION_ID } from "@/config";
import { getCollection } from "astro:content";
import { marked } from "marked";
import notebookRaw from "@/content/projects/notebook.md?raw";

// Get all weeks and sort by week number
const allWeeks = await getCollection("weeks");
const sortedWeeks = allWeeks
  .filter((week) => week.data.page !== false)
  .sort((a, b) => a.data.week - b.data.week);

function extractFirstSection(markdown: string) {
  const matches = Array.from(markdown.matchAll(/^##\\s+/gm));
  if (!matches.length) return markdown.trim();
  const start = matches[0].index ?? 0;
  const end = matches[1]?.index ?? markdown.length;
  return markdown.slice(start, end).trim();
}

const notebookSectionHtml = marked.parse(extractFirstSection(notebookRaw));
---

<Layout
  title={`Schedule - ${SITE_TITLE}: ${SECTION_ID}`}
  description={SITE_DESCRIPTION}
>
  <header>
    <div class="course-info flex flex-col">
      <CourseInfo />
      <h1>Schedule & <br />Weekly View</h1>
    </div>
  </header>
  <main>
    <Nav />
    <section class="project-intro" set:html={notebookSectionHtml} />
    <section class="weekly-grid">
      {
        sortedWeeks.map((week) => (
          <article class="week-card">
            <a href={`/${week.id}/`} class="week-link">
              <div class="week-number">Week {week.data.week}</div>
              <h2 class="week-title">{week.data.title}</h2>
              {week.data.description && (
                <div
                  class="week-description"
                  set:html={marked.parse(week.data.description)}
                />
              )}
            </a>
          </article>
        ))
      }
    </section>
  </main>
  <Footer />
</Layout>

<style>
  .weekly-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .project-intro {
    margin-bottom: 2rem;
  }

  .project-intro :global(h2) {
    margin-bottom: 1rem;
  }

  .project-intro :global(h3) {
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  .project-intro :global(p) {
    margin-bottom: 1rem;
  }

  .project-intro :global(ul) {
    padding-left: 1.25rem;
    margin-bottom: 1rem;
  }

  .project-intro :global(li) {
    margin-bottom: 0.35rem;
  }

  @media (max-width: 600px) {
    .weekly-grid {
      grid-template-columns: 1fr;
    }
  }

  .week-card {
    transition: all 0.2s ease;
    border-top: 2px solid var(--color-accent);
    padding: 2rem 0rem;
  }

  .week-card:hover {
    transform: translateY(-2px);
    background: color-mix(in srgb, var(--color-pink) 20%, transparent);
  }

  .week-link {
    display: block;
    color: inherit;
    text-decoration: none;
  }

  .week-number {
    opacity: 0.5;
    margin-bottom: 0.5rem;
    font-weight: 700;
    font-size: 0.875rem;
  }

  .week-title {
    margin-bottom: 0.75rem;
    font-weight: 700;
    font-size: 1.25rem;
    line-height: 1.3;
  }

  .week-description {
    opacity: 0.8;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .week-description :global(a) {
    color: inherit;
    text-decoration: underline;
  }
</style>
